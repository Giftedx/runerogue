<!-- Generated by SpecStory -->

# /fix  (2025-06-20 22:16:47)

_**User**_

/fix 

---

_**Assistant**_

Looking at the development workflow instructions, I can see several issues that need to be fixed:

1. **Inconsistent file path handling** - Mix of Windows and Unix path separators
2. **Missing error handling** in the setup script
3. **Incomplete performance monitoring** class implementation
4. **Syntax errors** in bash commands (missing quotes)
5. **Incomplete TypeScript examples**

Here's my proposed solution:

## Step-by-step Solution

1. **Fix cross-platform path handling** in the setup script
2. **Add proper error handling** for all operations
3. **Complete the performance monitoring implementation**
4. **Fix bash syntax errors** in commands
5. **Add missing TypeScript type definitions**
6. **Improve formatting and consistency**

## File Changes

### [development-workflow.instructions.md](file:///c%3A/Users/aggis/GitHub/runerogue/.github/instructions/development-workflow.instructions.md)

Update the automated setup script section to handle cross-platform paths properly and add better error handling:

````markdown
// ...existing code...

#### Automated Setup Script

Create a file `scripts/setup-dev.js`:

```javascript
#!/usr/bin/env node
const fs = require("fs");
const path = require("path");
const { execSync } = require("child_process");
const crypto = require("crypto");

// Check Node version
const nodeVersion = process.version.match(/^v(\d+)/)[1];
if (parseInt(nodeVersion) < 18) {
  console.error("âŒ Node.js 18+ required. Current version:", process.version);
  process.exit(1);
}

// Check pnpm
try {
  execSync("pnpm --version", { stdio: "ignore" });
} catch {
  console.error("âŒ pnpm not found. Install with: npm install -g pnpm");
  process.exit(1);
}

// Check mkcert
try {
  execSync("mkcert --version", { stdio: "ignore" });
} catch {
  console.error("âŒ mkcert not found. Please install mkcert first.");
  console.log("Windows: choco install mkcert");
  console.log("macOS: brew install mkcert");
  console.log("Linux: https://github.com/FiloSottile/mkcert/releases");
  process.exit(1);
}

console.log("âœ… Prerequisites checked");

// Install dependencies
console.log("ðŸ“¦ Installing dependencies...");
try {
  execSync("pnpm install", { stdio: "inherit" });
} catch (error) {
  console.error("âŒ Failed to install dependencies:", error.message);
  process.exit(1);
}

// Generate certificates
const clientPath = path.join(__dirname, "..", "packages", "phaser-client");
const serverPath = path.join(__dirname, "..", "packages", "server");

// Ensure directories exist
if (!fs.existsSync(clientPath)) {
  console.error(`âŒ Client path not found: ${clientPath}`);
  process.exit(1);
}

if (!fs.existsSync(serverPath)) {
  console.error(`âŒ Server path not found: ${serverPath}`);
  process.exit(1);
}

const keyPath = path.join(clientPath, "key.pem");
const certPath = path.join(clientPath, "cert.pem");

if (!fs.existsSync(keyPath) || !fs.existsSync(certPath)) {
  console.log("ðŸ” Generating HTTPS certificates...");
  try {
    execSync("mkcert -install", { stdio: "inherit" });
    execSync(
      "mkcert -key-file key.pem -cert-file cert.pem localhost 127.0.0.1 ::1",
      {
        cwd: clientPath,
        stdio: "inherit",
      }
    );

    // Copy to server
    fs.copyFileSync(keyPath, path.join(serverPath, "key.pem"));
    fs.copyFileSync(certPath, path.join(serverPath, "cert.pem"));
    console.log("âœ… Certificates generated and copied");
  } catch (error) {
    console.error("âŒ Failed to generate certificates:", error.message);
    process.exit(1);
  }
} else {
  console.log("âœ… Certificates already exist");
}

// Create .env files if they don't exist
const clientEnvPath = path.join(clientPath, ".env");
const serverEnvPath = path.join(serverPath, ".env");

if (!fs.existsSync(clientEnvPath)) {
  console.log("ðŸ“ Creating client .env file...");
  const clientEnv = `VITE_DISCORD_CLIENT_ID=your_discord_app_id
VITE_GAME_SERVER_URL=wss://localhost:2567
VITE_API_URL=https://localhost:2567
VITE_HTTPS_KEY=./key.pem
VITE_HTTPS_CERT=./cert.pem
`;
  fs.writeFileSync(clientEnvPath, clientEnv, "utf8");
}

if (!fs.existsSync(serverEnvPath)) {
  console.log("ðŸ“ Creating server .env file...");
  const jwtSecret = crypto.randomBytes(32).toString("hex");
  const serverEnv = `DISCORD_CLIENT_ID=your_discord_app_id
DISCORD_CLIENT_SECRET=your_client_secret
DISCORD_REDIRECT_URI=https://localhost:3000/auth/discord/callback
PORT=2567
NODE_ENV=development
JWT_SECRET=${jwtSecret}
HTTPS_KEY=./key.pem
HTTPS_CERT=./cert.pem
`;
  fs.writeFileSync(serverEnvPath, serverEnv, "utf8");
}

console.log("âœ… Development environment setup complete!");
console.log("\nðŸ“‹ Next steps:");
console.log("1. Update .env files with your Discord app credentials");
console.log('2. Run "pnpm dev" to start development servers');
```

// ...existing code...
````

Fix the Performance Monitoring Script section:

````markdown
// ...existing code...

### Performance Monitoring Script

Create a file `scripts/monitor-performance.js`:

```javascript
const { performance } = require("perf_hooks");
const os = require("os");

class PerformanceMonitor {
  constructor() {
    this.metrics = {
      tickTimes: [],
      memoryUsage: [],
      cpuUsage: [],
    };
    this.lastCpuUsage = process.cpuUsage();
  }

  start() {
    // Monitor tick rate
    let lastTick = Date.now();
    setInterval(() => {
      const now = Date.now();
      const tickTime = now - lastTick;
      this.metrics.tickTimes.push(tickTime);

      // Keep only last 60 samples
      if (this.metrics.tickTimes.length > 60) {
        this.metrics.tickTimes.shift();
      }

      lastTick = now;
    }, 1000);

    // Monitor memory
    setInterval(() => {
      const mem = process.memoryUsage();
      this.metrics.memoryUsage.push({
        rss: mem.rss,
        heapUsed: mem.heapUsed,
        external: mem.external,
      });

      if (this.metrics.memoryUsage.length > 60) {
        this.metrics.memoryUsage.shift();
      }
    }, 1000);

    // Monitor CPU
    setInterval(() => {
      const currentCpuUsage = process.cpuUsage(this.lastCpuUsage);
      const cpuPercent =
        (currentCpuUsage.user + currentCpuUsage.system) / 1000000; // Convert to seconds
      this.metrics.cpuUsage.push(cpuPercent);

      if (this.metrics.cpuUsage.length > 60) {
        this.metrics.cpuUsage.shift();
      }

      this.lastCpuUsage = process.cpuUsage();
    }, 1000);

    // Display stats
    setInterval(() => {
      this.displayStats();
    }, 5000);
  }

  displayStats() {
    console.clear();
    console.log("=== Performance Monitor ===");
    console.log(new Date().toLocaleTimeString());
    console.log("");

    // Tick rate stats
    if (this.metrics.tickTimes.length > 0) {
      const avgTick =
        this.metrics.tickTimes.reduce((a, b) => a + b, 0) /
        this.metrics.tickTimes.length;
      const minTick = Math.min(...this.metrics.tickTimes);
      const maxTick = Math.max(...this.metrics.tickTimes);
      console.log(
        `Tick Rate: ${(1000 / avgTick).toFixed(1)} TPS (min: ${minTick}ms, max: ${maxTick}ms)`
      );
    }

    // Memory stats
    if (this.metrics.memoryUsage.length > 0) {
      const latest =
        this.metrics.memoryUsage[this.metrics.memoryUsage.length - 1];
      console.log(
        `Memory: RSS ${(latest.rss / 1024 / 1024).toFixed(1)}MB, Heap ${(latest.heapUsed / 1024 / 1024).toFixed(1)}MB`
      );
    }

    // CPU stats
    if (this.metrics.cpuUsage.length > 0) {
      const avgCpu =
        this.metrics.cpuUsage.reduce((a, b) => a + b, 0) /
        this.metrics.cpuUsage.length;
      console.log(`CPU: ${avgCpu.toFixed(1)}% average`);
    }

    // System stats
    const totalMem = os.totalmem() / 1024 / 1024 / 1024;
    const freeMem = os.freemem() / 1024 / 1024 / 1024;
    console.log(
      `System: ${freeMem.toFixed(1)}GB free of ${totalMem.toFixed(1)}GB`
    );
  }
}

const monitor = new PerformanceMonitor();
monitor.start();

// Handle graceful shutdown
process.on("SIGINT", () => {
  console.log("\nShutting down performance monitor...");
  process.exit(0);
});
```

// ...existing code...
````

Fix the Discord-Specific Debugging section with proper TypeScript imports:

````markdown
// ...existing code...

### Discord-Specific Debugging

1. **Activity Not Loading**

   ```typescript
   // Add debug logging to Discord initialization
   console.log("[Discord] Initializing SDK...");
   console.log("[Discord] Client ID:", process.env.VITE_DISCORD_CLIENT_ID);
   console.log("[Discord] Running in iframe:", window.parent !== window);
   console.log("[Discord] Protocol:", window.location.protocol);

   // Verify CSP headers
   // Check Network tab for blocked requests
   // Look for frame-ancestors violations
   ```

2. **OAuth2 Issues**

   ```bash
   # Test token exchange endpoint
   curl -X POST https://localhost:2567/api/discord/token \
     -H "Content-Type: application/json" \
     -d '{"code":"test_auth_code"}'

   # Verify redirect URI matches exactly
   # Check for trailing slashes
   # Ensure HTTPS in production
   ```

3. **WebSocket Connection Issues**

   ```typescript
   import * as Colyseus from "colyseus.js";

   // Add connection debugging
   const client = new Colyseus.Client(process.env.VITE_GAME_SERVER_URL || "wss://localhost:2567", {
     requestTimeout: 10000,
   });

   // Note: Client error handling varies by Colyseus version
   // For v0.15.x:
   client.joinOrCreate("game_room", {}).then(room => {
     console.log("[Colyseus] Connected to room:", room.id);
   }).catch(error => {
     console.error("[Colyseus] Connection error:", error);
   });

   // Monitor in Chrome DevTools
   // Network tab > WS filter
   // Check for SSL certificate issues
   ```

### Common Discord Activity Issues

1. **Content Security Policy**

   ```typescript
   // Add to Vite config
   export default {
     server: {
       headers: {
         'Content-Security-Policy': "frame-ancestors https://discord.com https://discordapp.com",
       },
     }
   }
   ```

2. **CORS Issues**

   ```typescript
   import cors from "cors";
   import express from "express";

   const app = express();

   // Server CORS configuration
   app.use(
     cors({
       origin: [
         "https://discord.com",
         "https://discordapp.com",
         "https://localhost:3000",
         "null", // Discord iframe in development
       ],
       credentials: true,
     })
   );
   ```

// ...existing code...
````

This fix addresses the main issues:

1. **Cross-platform compatibility**: Uses `path.join()` consistently
2. **Error handling**: Added try-catch blocks and proper error messages
3. **Complete implementations**: Fixed the performance monitoring class
4. **Syntax fixes**: Corrected bash command quotes and escaping
5. **TypeScript improvements**: Added proper imports and type handling
6. **Better formatting**: Consistent code formatting throughout

The changes make the development workflow more robust and easier to follow, with better error messages and cross-platform support.

---

