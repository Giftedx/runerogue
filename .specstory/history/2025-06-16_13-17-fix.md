<!-- Generated by SpecStory -->

# /fix  (2025-06-16 14:17:03)

_**User**_

/fix 

---

_**Assistant**_

Looking at the development workflow instructions, I can see several areas that need improvement. Here's my analysis and proposed fixes:

## Step-by-step Solution

1. **Update the Initial Setup section** to include HTTPS certificate generation for Discord Activity development
2. **Fix the environment variable examples** to include all required variables for Discord integration
3. **Add missing Discord Activity setup instructions**
4. **Update the debugging section** with more specific Discord Activity troubleshooting
5. **Add a new section for Discord Activity-specific development workflow**

## Changes by File

### [development-workflow.instructions.md](file:///c%3A/Users/aggis/GitHub/runerogue/.github/instructions/development-workflow.instructions.md)

Update the development workflow instructions to properly support Discord Activity development, including HTTPS setup, proper environment variables, and Discord-specific debugging guidance.

````markdown
---
applyTo: "**"
---

# RuneRogue Development Workflow

## Development Environment Setup

### Prerequisites

- Node.js 18+
- pnpm package manager (v8+)
- Git version control
- Discord Developer Account (for Activity testing)
- mkcert (for HTTPS certificates in development)

### Initial Setup

```bash
# Clone repository
git clone <repository-url>
cd runerogue

# Install dependencies using pnpm workspaces
pnpm install

# Install mkcert for HTTPS certificates (required for Discord Activities)
# On Windows (with Chocolatey)
choco install mkcert

# On macOS
brew install mkcert

# On Linux
# Download from https://github.com/FiloSottile/mkcert/releases

# Install mkcert root certificate
mkcert -install

# Generate HTTPS certificates for local development
cd packages/phaser-client
mkcert -key-file key.pem -cert-file cert.pem localhost 127.0.0.1 ::1
cd ../..

# Copy certificates to server (if needed)
cp packages/phaser-client/*.pem packages/server/

# Set up environment files
# Create .env files for packages that need them
cat > packages/phaser-client/.env << EOF
VITE_DISCORD_CLIENT_ID=your_discord_app_id
VITE_GAME_SERVER_URL=wss://localhost:2567
VITE_API_URL=https://localhost:2567
VITE_HTTPS_KEY=./key.pem
VITE_HTTPS_CERT=./cert.pem
EOF

cat > packages/server/.env << EOF
DISCORD_CLIENT_ID=your_discord_app_id
DISCORD_CLIENT_SECRET=your_client_secret
DISCORD_REDIRECT_URI=https://localhost:3000/auth/discord/callback
PORT=2567
NODE_ENV=development
JWT_SECRET=your_jwt_secret_here
HTTPS_KEY=./key.pem
HTTPS_CERT=./cert.pem
EOF

# Start development servers
pnpm dev
```

### Discord Application Setup

1. **Create Discord Application**
   ```bash
   # Go to https://discord.com/developers/applications
   # Click "New Application"
   # Name it "RuneRogue" (or your preferred name)
   # Note the Application ID and Public Key
   ```

2. **Configure OAuth2**
   ```bash
   # In Discord Developer Portal:
   # Navigate to OAuth2 > General
   # Add redirect URLs:
   - https://localhost:3000/auth/discord/callback (development)
   - https://your-domain.com/auth/discord/callback (production)
   
   # Generate and save Client Secret
   ```

3. **Set Up Activity**
   ```bash
   # Navigate to Activities section
   # Configure:
   - Max Participants: 4
   - Supports Voice: Yes
   - Age Rating: E10+
   ```

4. **Add Test Users**
   ```bash
   # In App Settings > App Testers
   # Add your Discord user ID
   # Add team members' Discord IDs
   ```

## Daily Development Process

### 1. Start Development Session

```bash
# Pull latest changes
git pull origin main

# Clean install to avoid dependency issues
pnpm install --frozen-lockfile

# Verify HTTPS certificates exist
if [ ! -f packages/phaser-client/key.pem ]; then
  echo "Generating HTTPS certificates..."
  cd packages/phaser-client
  mkcert -key-file key.pem -cert-file cert.pem localhost 127.0.0.1 ::1
  cd ../..
fi

# Start all services in parallel
pnpm dev

# Or start specific services
pnpm --filter @runerogue/server dev
pnpm --filter @runerogue/phaser-client dev
```

### 2. Test Discord Activity

```bash
# Ensure Discord is running
# Open Discord and enable Developer Mode (User Settings > Advanced > Developer Mode)

# Join a test server
# Create or join a voice channel

# Test your activity
# 1. Click the Activities button (rocket icon) in voice channel
# 2. Search for your activity (may need to refresh)
# 3. Click to launch

# Monitor console for errors
# Use Discord DevTools (Ctrl+Shift+I in Discord client)
```

// ...existing code...

## Discord Activity Development

### Local Testing Workflow

1. **Start HTTPS Development Server**
   ```bash
   # Ensure certificates are generated
   ls packages/phaser-client/*.pem

   # Start with HTTPS
   pnpm --filter @runerogue/phaser-client dev

   # Verify HTTPS is working
   # Visit https://localhost:3000 and accept certificate
   ```

2. **Configure Discord Activity URL**
   ```bash
   # In Discord Developer Portal
   # Navigate to Activities > URL Mappings
   # Set development URL: https://localhost:3000
   ```

3. **Test in Discord**
   ```bash
   # Clear Discord cache if needed (Windows)
   %appdata%\discord\Cache
   
   # Clear Discord cache (macOS)
   ~/Library/Caches/discord
   
   # Restart Discord after clearing cache
   ```

### Discord-Specific Debugging

1. **Activity Not Loading**
   ```typescript
   // Add debug logging to Discord initialization
   console.log('[Discord] Initializing SDK...');
   console.log('[Discord] Client ID:', process.env.VITE_DISCORD_CLIENT_ID);
   console.log('[Discord] Running in iframe:', window.parent !== window);
   console.log('[Discord] Protocol:', window.location.protocol);

   // Verify CSP headers
   // Check Network tab for blocked requests
   // Look for frame-ancestors violations
   ```

2. **OAuth2 Issues**
   ```bash
   # Test token exchange endpoint
   curl -X POST https://localhost:2567/api/discord/token \
     -H "Content-Type: application/json" \
     -d '{"code":"test_auth_code"}'

   # Verify redirect URI matches exactly
   # Check for trailing slashes
   # Ensure HTTPS in production
   ```

3. **WebSocket Connection Issues**
   ```typescript
   // Add connection debugging
   const client = new Colyseus.Client(process.env.VITE_GAME_SERVER_URL!, {
     requestTimeout: 10000,
   });

   client.onError.add((error) => {
     console.error('[Colyseus] Connection error:', error);
   });

---

