<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RuneRogue - Connection Test</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #2d4a22, #3d5a32);
        font-family: 'Courier New', monospace;
        color: #ffffff;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 8px;
        border: 2px solid #654321;
      }

      .log {
        background: #000;
        color: #00ff00;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-family: monospace;
        max-height: 400px;
        overflow-y: auto;
      }

      button {
        background: #654321;
        color: #ffffff;
        border: 2px solid #8b4513;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 4px;
        cursor: pointer;
        font-family: 'Courier New', monospace;
      }

      button:hover {
        background: #8b4513;
      }

      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }

      .status.success {
        background: #0f4d0f;
        color: #00ff00;
      }
      .status.error {
        background: #4d0f0f;
        color: #ff0000;
      }
      .status.warning {
        background: #4d4d0f;
        color: #ffff00;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🎮 RuneRogue Connection Test</h1>
      <p>This page tests the browser client connection to the RuneRogue server.</p>

      <div id="status" class="status warning">Initializing...</div>

      <div>
        <button onclick="testConnection()">🔌 Test Connection</button>
        <button onclick="clearLog()">🧹 Clear Log</button>
        <button onclick="testLibraries()">📚 Test Libraries</button>
      </div>

      <div id="log" class="log">
        <div>🚀 Connection test ready...</div>
      </div>
    </div>

    <!-- Buffer polyfill for browser compatibility -->
    <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.js"></script>
    <script>
      // Make Buffer globally available for Colyseus
      window.Buffer = buffer.Buffer;
      log('✅ Buffer polyfill loaded');
    </script>

    <!-- Colyseus client library -->
    <script src="https://unpkg.com/colyseus.js@^0.15.0/dist/colyseus.js"></script>

    <script>
      // Global variables
      let room = null;
      let client = null;

      function log(message, color = '#00ff00') {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.style.color = color;
        logEntry.innerHTML = `[${timestamp}] ${message}`;
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(message);
      }

      function setStatus(message, type) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
      }

      function clearLog() {
        document.getElementById('log').innerHTML = '<div>🧹 Log cleared...</div>';
      }

      function testLibraries() {
        log('🔍 Testing library availability...');

        if (typeof window.Buffer !== 'undefined') {
          log('✅ Buffer polyfill available', '#00ff00');
        } else {
          log('❌ Buffer polyfill missing', '#ff0000');
        }

        if (typeof window.Colyseus !== 'undefined') {
          log('✅ Colyseus library available', '#00ff00');
          log(`   Colyseus type: ${typeof window.Colyseus}`, '#ffff00');

          if (window.Colyseus.Client) {
            log('✅ Colyseus.Client constructor available', '#00ff00');
          } else {
            log('❌ Colyseus.Client constructor missing', '#ff0000');
            log('   Available Colyseus properties:', '#ffff00');
            Object.keys(window.Colyseus).forEach(key => {
              log(`   - ${key}: ${typeof window.Colyseus[key]}`, '#ffff00');
            });
          }
        } else {
          log('❌ Colyseus library missing', '#ff0000');
        }
      }

      async function testConnection() {
        try {
          setStatus('🔌 Testing connection...', 'warning');
          log('🔌 Starting connection test...');

          // Test 1: Library check
          testLibraries();

          // Test 2: Create client
          log('📝 Creating Colyseus client...');

          if (!window.Colyseus) {
            throw new Error('Colyseus library not loaded');
          }

          let client;
          if (window.Colyseus.Client) {
            client = new window.Colyseus.Client('ws://localhost:3001');
            log('✅ Client created using new Colyseus.Client()', '#00ff00');
          } else if (typeof window.Colyseus === 'function') {
            client = window.Colyseus('ws://localhost:3001');
            log('✅ Client created using Colyseus() function', '#00ff00');
          } else {
            throw new Error('No valid Colyseus client constructor found');
          }

          // Test 3: Join room
          log('🏠 Joining room...');
          const username = `TestUser_${Math.floor(Math.random() * 1000)}`;

          room = await client.joinOrCreate('runerogue', {
            username,
            combatStats: {
              attack: 50,
              strength: 50,
              defence: 45,
              hitpoints: 50,
              prayer: 25,
              ranged: 35,
              magic: 30,
            },
          });

          log(`✅ Connected to room! Session ID: ${room.sessionId}`, '#00ff00');
          setStatus('✅ Connected successfully!', 'success');

          // Test 4: Set up event handlers
          room.onMessage('fullState', gameState => {
            log(
              `📊 Received fullState: ${Object.keys(gameState.players || {}).length} players`,
              '#00ffff'
            );
          });

          room.onMessage('playerJoined', player => {
            log(`👤 Player joined: ${player.username}`, '#ffff00');
          });

          room.onMessage('chatMessage', data => {
            log(`💬 Chat: ${data.username}: ${data.message}`, '#ff00ff');
          });

          room.onMessage('skillsData', skills => {
            log(`⚡ Skills data received: ${Object.keys(skills).length} skills`, '#00ffff');
          });

          room.onMessage('inventoryData', inventory => {
            log(`🎒 Inventory data received: ${inventory.items.length} items`, '#00ffff');
          });

          // Test 5: Send test messages
          log('📤 Sending test messages...');
          room.send('chat', { message: 'Hello from browser test client!' });
          room.send('getSkills');
          room.send('getInventory');

          log('🎉 All tests completed successfully!', '#00ff00');
        } catch (error) {
          log(`❌ Connection test failed: ${error.message}`, '#ff0000');
          setStatus(`❌ Connection failed: ${error.message}`, 'error');
          console.error('Full error:', error);

          if (error.message.includes('ECONNREFUSED')) {
            log('💡 Make sure the server is running on port 3001', '#ffff00');
          }
        }
      }

      // Auto-run tests when page loads
      window.addEventListener('load', () => {
        log('🌐 Page loaded, libraries ready');
        testLibraries();
        setStatus('Ready to test connection', 'warning');
      });

      // Error handling
      window.addEventListener('error', event => {
        log(`🚨 JavaScript Error: ${event.error?.message || event.message}`, '#ff0000');
        console.error('Error details:', event);
      });

      window.addEventListener('unhandledrejection', event => {
        log(`🚨 Unhandled Promise Rejection: ${event.reason}`, '#ff0000');
        console.error('Promise rejection details:', event);
      });
    </script>
  </body>
</html>
